#!/bin/bash 
function INTRO()
{
    # Define Colors
    GREEN='\033[1;32m'   #HEX green
    BLUE='\033[1;34m'    # Flag Blue
    BLACK='\033[1;30m'   # Dark Gray
    RESET='\033[0m'

    # 1. The Matrix Noise (Green)
    echo -e "${GREEN}"
    timeout 2s hexdump -C /dev/urandom
    
    # 2. Decrypting Phase
    clear
    echo -e "${GREEN} > SYSTEM ACCESS: GRANTED"
    sleep 0.3
    echo -e "${GREEN} > INITIALIZING PROJECT PROTOCOL..."
    sleep 0.3
    clear

    # 3. The "3D Cyber-Flag" Reveal
    
    echo -e "${BLUE}"
    # Top
    echo "      /=======================================================\\"
    sleep 0.03
    # Upper Side (Note the /| for 3D effect)
    echo "     /                                                       /|"
    sleep 0.03
    echo "    /           PENETRATION TESTING PROJECT                 / |"
    sleep 0.03
    # Middle (The Arrows)
    echo -e "   <${BLACK}=======================================================${BLUE}>  |"
    sleep 0.03
    # Lower Side (Note the \| for 3D effect)
    echo "    \\                                                       \\ |"
    sleep 0.03
    echo -e "     \\               ${BLACK}By Reut Abergel${BLUE}                         \\|"
    sleep 0.03
    # Bottom
    echo "      \\=======================================================/"
    sleep 0.03
    
    # The Pole / Base (Black)
    echo -e "${BLACK}                               ||"
    sleep 0.03
    echo "                             __||__"
    sleep 0.03
    echo "                             \\    /"
    sleep 0.03
    echo "                              \\__/"
    echo -e "${RESET}"
    echo ""
    sleep 1
}
function USER_INP()
{
	#1. Getting the User Input
#1.2 Get from the user a name for the output directory.
read -p "please specify a directory to save the output in:" DR
if [ ! -d "$DR" ]
  then
      mkdir "$DR"
fi
echo  "-----directory is $DR----" 
#1.1 Get from the user a network to scan.
read -p "please write a valid ip range with cider to scan:" IPRNG
export IPRNG
echo "---ip is $IPRNG----"
}
function VLDT ()
{
#1.4 Make sure the input is valid. checks the file and if its
echo "checking if ip is valid, starting to scan"	
nmap $IPRNG -sL -n 2> "$DR/error.log" 1> "$DR/valid_target_list.txt"
if [ -s "$DR/error.log" ]
  then
      echo "Wrong input, try again."
  return
  else
      echo "IP input is valid!"
fi
}	
function FRSTSCN()
{
    if [ ! -d "$DR/checkip_results" ]
	  then
        mkdir -p "$DR/checkip_results"
    fi
    if [ ! -f "$DR/valid_target_list.txt" ]
      then
        echo "Error: Target list not found.VLDT didnt run"
      return
    fi
    > "$DR/active_ips.txt"
    for IP in $(cat "$DR/valid_target_list.txt" | awk '/Nmap scan report/{print $NF}')
    do 
        echo "scanning ip $IP"
        SCAN_RESULT=$(nmap -F "$IP")
        if echo "$SCAN_RESULT" |grep -q "Host is up"
          then
               echo "[(:]found active host: $IP, saving..."
               echo "$SCAN_RESULT" > "$DR/checkip_results/$IP"
               echo "$IP" >> "$DR/active_ips.txt"
        else
		    echo "[!] $IP is down,skipping"
		fi    
    done
    echo "Scan complete. Results saved in $DR/checkip_results/"
}

function BF_scn ()
{
#1.3 Allow the user to choose 'Basic' or 'Full'.
#1.3.1 Basic: scans the network for TCP and UDP, including the service version and weak
#passwords.
#1.3.2 Full: include Nmap Scripting Engine (NSE), weak passwords, and vulnerability analysis.
#3. Mapping Vulnerabilities
#3.1 Mapping vulnerabilities should only take place if Full was chosen.

echo "Full: include Nmap Scripting Engine OR Basic: scans the network for TCP and UDP"
read -p "---please choose method to scan([B]asic or [F]ull)---:" METH 
# Useing ${METH^^} to handle lowercase input (b/f)
export DATF=""
case ${METH^^} in 
	B)
	echo "you chose B for basic TCP and UDP scannig"
	echo "range to scan is $IPRNG"
	read -p "enter a new dirctory to save the data:" DATF
	mkdir -p "$DR/$DATF"
	echo "starting basic scan on active IPs (UDP + TCP) this may take a while:"
	for bip in $(cat "$DR/active_ips.txt")
	   do 
		 sudo nmap -sS -sV  "$bip" -oN "$DR/$DATF/${bip}.txt"
    done
    clear
    echo "-----------------------------------------------------------"
	echo "-----------------------------------------------------------"
    echo "!!!!!!!!!!!!!!!!!IMPORTANT FINDINGS ONLY!!!!!!!!!!!!!!!!!!!"
    echo "-----------------------------------------------------------"
    echo "-----------------------------------------------------------"
    grep -E -C 5 --color=always "Nmap scan report|PORT|open" "$DR/$DATF"/*.txt
	echo "basic scan details saved in $DR/$DATF"
	;;
	F)
	echo "you chose F for full scan with nmap scripts"
	echo "range is $IPRNG"
	echo "starting Full scan with nse (nmap script engine) this may take a while...:"
	echo "you can press space for estimated time"
	read -p "enter a new dirctory to save the data:" DATF
	mkdir -p "$DR/$DATF"
	for fip in $(cat "$DR/active_ips.txt") 
	   do		
		 #saving the data also in xml format to use with searchsploit
		 echo "[(:] Scanning IP: $fip (Please wait...)"
		 sudo nmap -A -sV -O -p- --script=vuln,brute "$fip" -oN "$DR/$DATF/${fip}.txt" -oX "$DR/$DATF/${fip}.xml"
     done
     clear 
	#3.2 Display potential vulnerabilities via NSE and Searchsploit.
	echo "--------------------------------------------------------"
	echo "--------------------------------------------------------"
    echo "           SEARCHSPLOIT FINDINGS                        "
    echo "--------------------------------------------------------"
    echo "--------------------------------------------------------"
    for fxml in "$DR/$DATF"/*.xml
       do
         if [ -f "$fxml" ]
           then
               echo "---Results for: $(basename "$fxml" .xml)---"
               searchsploit --nmap "$fxml"
           else
              echo "Error: XML file not found, skipping Searchsploit."
         fi
     done 
    echo "-----------------------------------------------------------"     
    echo "-----------------------------------------------------------"
    echo "!!!!!!!!!!!!!!!!!IMPORTANT FINDINGS ONLY!!!!!!!!!!!!!!!!!!!" 
    echo "-----------------------------------------------------------"
    echo "-----------------------------------------------------------"
    grep -E -C 5 --color=always "Nmap scan report|PORT +STATE| open |VULNERABLE|CVE-|Risk factor|Valid credentials|Running:|OS details" "$DR/$DATF"/*.txt
    echo "==========================================================="
    echo "Full scan complete! details saved in $DR/$DATF"
	;;
	*)
	echo "[!!] not a valid pick [!!]"
	;;
esac

}
function HYDRA()
{
#2. Weak Credentials using hydra and medusa 
#2.1 Look for weak passwords used in the network for login services.
#2.1.1 Have a built-in password.lst to check for weak passwords. google  or hydra has a deaffult weak passwordlist dpl4hydra 
#2.1.2 Allow the user to supply their own password list. give a path or something and also check if thers a file with = if [ -f "file name"];then "good thers a file" else "thers no file"
#2.2 Login services to check include: SSH, RDP, FTP, and TELNET. if the ip that you are scannig has those ports open you want to go inside and check for weak password and Credentials
	echo "starting weak passwords check with hydra "
#to use hydra we need a pass list a userlist (or username) the services and the ip bulding it now 
	read -p "enter a user list or skip and use Default user list: " USER_LIST
	USER_LIST=${USER_LIST:-/usr/share/wordlists/metasploit/unix_users.txt} 
	read -p "enter path to a pass list or press enter and use the default (rockyou.txt): " PASS_LIST
	PASS_LIST=${PASS_LIST:-/usr/share/wordlists/rockyou.txt}
    
    if [ -f "$PASS_LIST" ]
		then
        echo "[(:] pass file found using $PASS_LIST"
    else
        echo "[!!] error cannot find the password list you gave using rockyou.txt"
        PASS_LIST="/usr/share/wordlists/rockyou.txt" 
    fi
    target_ports="21 22 23 3389 445"
	echo "cheacking for open ports on $IPRNG:"
	nmap -p 21,22,23,3389,445 -iL "$DR/active_ips.txt" -oG "$DR/port_info.txt" > /dev/null 
	cat "$DR/port_info.txt" | grep "/open" | while read line
		do
        current_ip=$(echo $line | awk '{print $2}')
        
        for port in $target_ports
           do
             if echo "$line" | grep -q " $port/open"
               then
                 echo "[*] Found open port $port on $current_ip. Starting Hydra..."
                
               
                service=""
                case $port in
                    21) service="ftp" ;;
                    22) service="ssh" ;;
                    23) service="telnet" ;;
                    445) service="smb" ;;
                    3389) service="rdp" ;;
                esac
                
                
                if [ ! -z "$service" ]
				  then
                      hydra -L "$USER_LIST" -P "$PASS_LIST" "$service://$current_ip" -o "$DR/$DATF/hydra_${current_ip}_${service}.txt" -t 4
                fi
            fi
        done
    done
    echo "hydra input saved in $DR/$DATF "	
}	
#4. Log Results
#4.1 During each stage, display the stage in the terminal.
#4.2 At the end, show the user the found information.
#4.3 Allow the user to search inside the results.
function INSPCT()
{
	echo "-----------------------------------------------------------"
    echo "                   INSPECT RESULTS                         "
    echo "-----------------------------------------------------------"
while true
     do
       echo "Available Scan Reports:"
       ls "$DR/$DATF"/*.txt | xargs -n 1 basename
       read -p "Enter the IP you want to inspect (or 'q' to quit):" IPI
       if [ "$IPI" == "q" ]
         then
             echo "Exiting inspection."
             break
        fi
        req_file="$DR/$DATF/${IPI}.txt"
        if [ -f "$req_file" ]
          then
              echo "--- Displaying contents of $IPI ---"
              echo "Tip: Press 'q' to exit the view."
              sleep 1
              less "$req_file"
         fi
done     	
}

function ZIP()
{
#4.4 Allow to save all results into a Zip file.
read -p "Do you want to zip the results and delete the original folder? (y/n): " CHOICE
if [[ "$CHOICE" =~ ^[Yy]$ ]]
  then
      ZIP_NAME="scan_info_$(date +%F_%H-%M-%S).zip" 
      if zip -r -q "$ZIP_NAME" "$DR"
        then
            rm -rf "$DR"
            echo "[(:] Zip successful saved as $ZIP_NAME. Original folder removed."
        else
             echo "[!] Error: Zip failed! I kept the folder '$DR' so you don't lose data."
        fi
   else
       echo "[!!]Skipping zip. the scan information remains in '$DR'."
fi 
}
function NEWOT()
{
    # Define Colors
    YELLOW='\033[1;33m'
    RESET='\033[0m'

    echo ""
    echo -e "${YELLOW}"
    echo "       (^\.            .^\.)"
    echo "       ((\^^.        .^^))"
    echo "         \ ' \.-----./   /"
    echo "          \              /"
    echo "          (            )    _ ._ /\\"
    echo "          ( (o  _  o)  )   \./       )"
    echo "          (0   \^/   0)  \\      ___\\"
    echo "          |            |   .)  \\"
    echo "          /  \    /    \  (). ^"
    echo "         /  \ \  / /    ( .. )"
    echo "        (      _) (_/    ). ^"
    echo "        (                )"
    echo "         \.            ./"
    echo "           (__)----(__)"
    echo -e "${RESET}"
    
   
    echo ""
}
function OUTRO()
{
    # Define Colors
    BLUE='\033[1;34m'
    CYAN='\033[1;36m'
    RESET='\033[0m'

    echo ""
    echo -e "${BLUE}"
    echo "      .___________________________________________________."
    sleep 0.1
    echo "      |                                                   |"
    sleep 0.1
    
    echo -e "      |          ${CYAN}Thank you for using this tool!${BLUE}           |"
    sleep 0.1
    echo "      |___________________________________________________|"
    echo -e "${RESET}"
    echo ""
}
INTRO
USER_INP
VLDT
FRSTSCN
BF_scn
HYDRA
INSPCT
ZIP
NEWOTS
OUTRO
